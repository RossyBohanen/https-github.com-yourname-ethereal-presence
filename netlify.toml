[build]
  command = "npm run build"
  publish = "dist"

# Functions Configuration
[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
  included_files = ["lib/**"]

# Branch Deploy Configuration
# Enable automatic deploys for specific branches
[build.environment]
  NODE_VERSION = "22"

# Production context: applies to the main branch
[context.production]
  command = "npm run build"
  [context.production.environment]
    NODE_ENV = "production"

# Staging context: applies to the staging branch
# URL: staging--effortless-raindrop-63b879.netlify.app
[context.staging]
  command = "npm run build"
  [context.staging.environment]
    NODE_ENV = "staging"

# Develop context: applies to the develop branch
# URL: develop--effortless-raindrop-63b879.netlify.app
[context.develop]
  command = "npm run build:ci"
  [context.develop.environment]
    NODE_ENV = "development"

# Deploy preview context: applies to pull request previews
[context.deploy-preview]
  command = "npm run build:ci"
  [context.deploy-preview.environment]
    NODE_ENV = "development"

# Branch deploy settings - which branches to auto-deploy
# All branches matching these patterns will get their own deploy preview URLs

# SPA Redirect - ensure all routes go to index.html
# Serverless functions directory
[functions]
  directory = "netlify/functions"

# Configure the Cloudinary plugin that was added via Netlify UI
# The cloudName can be set here or via CLOUDINARY_CLOUD_NAME environment variable
# To use real Cloudinary features, set the env var in Netlify UI with your actual cloud name
[[plugins]]
  package = "netlify-plugin-cloudinary"
  [plugins.inputs]
    cloudName = "demo"

# Redirect rules
# API proxy example - redirect old API paths to functions
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200

# Legacy path redirects
[[redirects]]
  from = "/old-path"
  to = "/new-path"
  status = 301

# External redirect example
[[redirects]]
  from = "/docs"
  to = "https://docs.netlify.com"
  status = 302

# SPA fallback - serves index.html for client-side routing
# Must be last as it's a catch-all
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# Security Headers
[[headers]]
  for = "/*"
  [headers.values]
    # Prevent clickjacking attacks
    X-Frame-Options = "DENY"
    # Prevent MIME-type sniffing attacks
    X-Content-Type-Options = "nosniff"
    # Enable browser XSS filtering
    X-XSS-Protection = "1; mode=block"
    # Control referrer information leakage
    Referrer-Policy = "strict-origin-when-cross-origin"
    # Restrict browser features (camera, microphone, geolocation)
    Permissions-Policy = "camera=(), microphone=(), geolocation=()"
    # Enforce HTTPS connections (1 year with subdomains and preload)
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"
    # Content Security Policy - controls which resources can be loaded
    Content-Security-Policy = "default-src 'self'; script-src 'self' https://cdn.tailwindcss.com 'unsafe-inline'; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://res.cloudinary.com; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'"

# Cache static assets for performance
# Header rules for security and caching
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    # HSTS - enforce HTTPS for 1 year, include subdomains
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"
    # Permissions Policy - restrict browser features
    Permissions-Policy = "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
    # Content Security Policy - adjust as needed for your application
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://api.netlify.com"

# Cache static assets
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Disable caching for HTML to ensure fresh content
[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

# Edge Functions Configuration
# Explicit ordering: rate-limiter runs first, then request-logger, then geo-context
[[edge_functions]]
  path = "/api/*"
  function = "rate-limiter"

[[edge_functions]]
  path = "/api/*"
  function = "request-logger"

[[edge_functions]]
  path = "/api/*"
  function = "geo-context"

# Cloudinary Plugin Configuration
# The plugin is installed via Netlify app and requires a cloud name.
# Using 'demo' as a working placeholder - replace with your actual cloud name
# by setting the CLOUDINARY_CLOUD_NAME environment variable in Netlify UI.
[[plugins]]
  package = "netlify-plugin-cloudinary"
  [plugins.inputs]
    cloudName = "demo"
    deliveryType = "fetch"
# Cache JavaScript and CSS files
[[headers]]
  for = "*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# No-cache for HTML files to ensure fresh content
[[headers]]
  for = "*.html"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

