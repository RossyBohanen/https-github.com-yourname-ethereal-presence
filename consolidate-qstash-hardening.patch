From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Copilot <copilot@example.com>
Date: Sat, 06 Dec 2025 00:00:00 +0000
Subject: [PATCH] Consolidate QStash hardening, remove .env.local, add governance files & tests

---
 .env.local                                        |  26 --------------------------
 .env.example                                      | 101 ++++++++++++++++++++++++++++++++++++++++++++++++++
 LICENSE                                           |  14 ++++++++++
 README.md                                         |  56 +++++++++++++++++++++++++++++++
 CONTRIBUTING.md                                   |  55 ++++++++++++++++++++++++++++++
 SECURITY.md                                       |  26 +++++++++++++
 CODE_OF_CONDUCT.md                                |  10 ++++++
 lib/queue/qstash.ts                               | 190 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 package.json                                      |  30 +++++++++++
 tests/qstash.test.ts                              |  30 +++++++++++
 tsconfig.json                                     |  30 +++++++++++
 .gitignore                                        |  16 ++++++++
 12 files changed, 595 insertions(+), 26 deletions(-)
 delete mode 100644 .env.local
 create mode 100644 LICENSE
 create mode 100644 README.md
 create mode 100644 CONTRIBUTING.md
 create mode 100644 SECURITY.md
 create mode 100644 CODE_OF_CONDUCT.md
 create mode 100644 lib/queue/qstash.ts
 create mode 100644 tests/qstash.test.ts
 create mode 100644 consolidate-qstash-hardening.patch
 create mode 100644 .gitignore
 create mode 100644 .env.example
 create mode 100644 package.json
 create mode 100644 tsconfig.json

diff --git a/.env.local b/.env.local
deleted file mode 100644
index 6f7e8d1..0000000
--- a/.env.local
+++ /dev/null
@@ -1,26 +0,0 @@
-# OpenTelemetry Configuration
-OTEL_EXPORTER_OTLP_ENDPOINT=https://ingest.kubiks.app
-OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf
-OTEL_EXPORTER_OTLP_HEADERS=x-kubiks-key=kubiks_26fce4302e29ccac0c1d55851eddb20d35aa4c601c8d21e81270ec56d3ff4834
-OTEL_SERVICE_NAME=ethereal-presence
-
-# Database
-DATABASE_URL=postgres://user:password@localhost:5432/ethereal_presence
-
-# Authentication
-BETTER_AUTH_SECRET=your-secret-key-here
-BETTER_AUTH_URL=http://localhost:3000
-GOOGLE_CLIENT_ID=
-GOOGLE_CLIENT_SECRET=
-GITHUB_CLIENT_ID=
-GITHUB_CLIENT_SECRET=
-
-# Email Service (Resend)
-RESEND_API_KEY=
-
-# Job Queue (QStash)
-QSTASH_TOKEN=
-QSTASH_BASE_URL=http://localhost:3000
-
-# Billing (Autumn)
-AUTUMN_API_KEY=
diff --git a/.env.example b/.env.example
new file mode 100644
index 0000000..d5af1ce
--- /dev/null
+++ b/.env.example
@@ -0,0 +1,101 @@
+# Ethereal Presence - Environment Variables (example)
+# Copy this file to .env.local for local development.
+# DO NOT commit actual secret values. Use your platform (Vercel/Netlify) env UI for production.
+
+# --------------------------------------------
+# App
+# --------------------------------------------
+NODE_ENV=development
+PORT=3000
+NEXT_PUBLIC_APP_URL=http://localhost:3000
+
+# --------------------------------------------
+# Database
+# --------------------------------------------
+DATABASE_URL=postgres://user:password@localhost:5432/ethereal_presence
+
+# --------------------------------------------
+# Authentication
+# --------------------------------------------
+BETTER_AUTH_SECRET=your-secret-key
+BETTER_AUTH_URL=http://localhost:3000
+GOOGLE_CLIENT_ID=
+GOOGLE_CLIENT_SECRET=
+GITHUB_CLIENT_ID=
+GITHUB_CLIENT_SECRET=
+
+# --------------------------------------------
+# Email (Resend)
+# --------------------------------------------
+RESEND_API_KEY=
+
+# --------------------------------------------
+# QStash (Upstash - Job Queue)
+# --------------------------------------------
+# QSTASH_TOKEN: Upstash token for publishing to QStash (server-only)
+# QSTASH_BASE_URL: base URL to build webhook target URLs (e.g. https://yourapp.example.com)
+QSTASH_TOKEN=
+QSTASH_BASE_URL=https://yourapp.example.com
+
+# --------------------------------------------
+# Billing (Autumn)
+# --------------------------------------------
+AUTUMN_API_KEY=
+
+# Note: If any secret values were accidentally committed (for example in .env.local),
+# rotate them immediately and remove the file from the repository.
diff --git a/LICENSE b/LICENSE
new file mode 100644
index 0000000..9b2f3c1
--- /dev/null
+++ b/LICENSE
@@ -0,0 +1,14 @@
+MIT License
+
+Copyright (c) 2025 RossyBohanen
+
+Permission is hereby granted, free of charge, to any person obtaining a copy
+of this software and associated documentation files (the "Software"), to deal
+in the Software without restriction, including without limitation the rights
+to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+copies of the Software, and to permit persons to whom the Software is
+furnished to do so, subject to the following conditions:
diff --git a/README.md b/README.md
new file mode 100644
index 0000000..1a0df1b
--- /dev/null
+++ b/README.md
@@ -0,0 +1,56 @@
+# Ethereal Presence
+
+Ethereal Presence is a TypeScript + React app with server-side components that use Upstash QStash for background jobs.
+
+## Quick start (local)
+
+1. Copy example env:
+   cp .env.example .env.local
+2. Install
+   npm ci
+3. Run dev
+   npm run dev
+4. Build
+   npm run build
+5. Test
+   npm run test
+6. Preview
+   npm run preview
+
+## Environment
+
+See `.env.example` for required environment variables. Important items:
+- QSTASH_TOKEN — server-only Upstash QStash token (do not commit)
+- QSTASH_BASE_URL — public base URL used to build webhook target URLs
+
+## QStash
+
+Server code that publishes jobs is located at `lib/queue/qstash.ts`. Code is defensive:
+- Publishing functions return a structured result `{ ok, id?, error? }`.
+- If QSTASH_TOKEN is not set, publish operations return a clear failure and do not attempt to contact Upstash.
+
+## Contributing
+
+Please see CONTRIBUTING.md for contribution guidelines, branch naming, and PR checklist.
+
+## Security
+
+If you discover a security issue, follow SECURITY.md to report it responsibly.
+
+## Deployment
+
+This project is typically deployed on Vercel. If you have a previously misconfigured homepage or deployment URL,
+update the "Homepage" / site URL in the repository settings and update Vercel environment variables accordingly.
diff --git a/CONTRIBUTING.md b/CONTRIBUTING.md
new file mode 100644
index 0000000..284f6b1
--- /dev/null
+++ b/CONTRIBUTING.md
@@ -0,0 +1,55 @@
+# Contributing
+
+Thanks for wanting to contribute!
+
+## Run locally
+- cp .env.example .env.local
+- npm ci
+- npm run dev
+
+## Branching
+- Feature branches: feat/<short-description>
+- Fix branches: fix/<short-description>
+- Chore branches: chore/<short-description>
+
+## PR Checklist
+- [ ] Code builds: npm run build
+- [ ] Type-checks: tsc
+- [ ] Lint passes (if applicable)
+- [ ] Tests added/updated
+- [ ] No secrets in commits
+- [ ] Add entry to CHANGELOG if behavior changes
+
+## Consolidating related PRs
+If you have multiple small PRs targeting the same area (e.g., QStash hardening), prefer a single consolidated PR:
+- Create a branch named feat/qstash-hardening
+- Combine the changes, fix conflicts, add tests and documentation
+- Use a clear PR description that explains the motivation, changes, and manual steps (rotate secrets, env updates)
diff --git a/SECURITY.md b/SECURITY.md
new file mode 100644
index 0000000..c3f9a2d
--- /dev/null
+++ b/SECURITY.md
@@ -0,0 +1,26 @@
+# Security Policy
+
+Report security issues responsibly.
+
+If you discover a potential security vulnerability, please do NOT open a public issue.
+
+Preferred contact: create a private issue or email SECURITY@github.com (placeholder).
+You can also use GitHub's private security advisories if available for this repository.
+
+Please include:
+- Steps to reproduce
+- Affected versions/commits
+- Any PoC or exploit details (if possible)
+
+We will respond within a reasonable timeframe and work with you for remediation.
diff --git a/CODE_OF_CONDUCT.md b/CODE_OF_CONDUCT.md
new file mode 100644
index 0000000..f6a2b3e
--- /dev/null
+++ b/CODE_OF_CONDUCT.md
@@ -0,0 +1,10 @@
+# Contributor Covenant Code of Conduct
+
+This project follows the Contributor Covenant. Be respectful and constructive. If you experience or observe unacceptable behavior, please report it as described in SECURITY.md.
diff --git a/lib/queue/qstash.ts b/lib/queue/qstash.ts
new file mode 100644
index 0000000..313f744
--- /dev/null
+++ b/lib/queue/qstash.ts
@@ -0,0 +1,190 @@
+import { Client } from "@upstash/qstash";
+import { instrumentUpstash } from "@kubiks/otel-upstash-queues";
+
+/**
+ * Structured publish result returned to callers so they can react programmatically.
+ */
+export type PublishResult = {
+  ok: boolean;
+  id?: string;
+  error?: string;
+};
+
+type UpstashClientLike = {
+  publishJSON?: (opts: any) => Promise<string | { id?: string } | void>;
+};
+
+const QSTASH_TOKEN = process.env.QSTASH_TOKEN ?? "";
+const QSTASH_BASE_URL = process.env.QSTASH_BASE_URL ?? "http://localhost:3000";
+
+let client: UpstashClientLike;
+let isRealClient = false;
+
+/**
+ * Initialize real client if token exists; otherwise provide a stub client that fails fast.
+ */
+if (QSTASH_TOKEN && QSTASH_TOKEN.trim() !== "") {
+  client = new Client({ token: QSTASH_TOKEN });
+  try {
+    // Instrumentation is optional and must not throw on failure
+    instrumentUpstash(client as any);
+  } catch (err) {
+    // Do not fail app if instrumentation fails
+    // eslint-disable-next-line no-console
+    console.warn("[qstash] instrumentation failed:", (err as Error).message);
+  }
+  isRealClient = true;
+} else {
+  // Stub client that throws a clear error to prevent accidental use in browser or unconfigured environments
+  client = {
+    publishJSON: async () => {
+      throw new Error(
+        "QStash client not configured: QSTASH_TOKEN is missing. Publishing is a server-only operation."
+      );
+    },
+  };
+  isRealClient = false;
+}
+
+export default client as UpstashClientLike;
+
+/**
+ * Normalize the publish result and handle errors centrally.
+ */
+export async function safePublishJSON(payload: any): Promise<PublishResult> {
+  if (!isRealClient) {
+    return {
+      ok: false,
+      error: "QStash not configured (QSTASH_TOKEN missing). Operation not performed.",
+    };
+  }
+
+  try {
+    const res: any = await client.publishJSON?.(payload);
+    const id = typeof res === "string" ? res : res?.id ?? undefined;
+    return { ok: true, id };
+  } catch (err) {
+    return { ok: false, error: (err as Error).message || String(err) };
+  }
+}
+
+/* ---------- Validation helpers ---------- */
+
+function isNonEmptyString(v: unknown): v is string {
+  return typeof v === "string" && v.trim().length > 0;
+}
+
+function isValidEmail(v: unknown): v is string {
+  return typeof v === "string" && /\S+@\S+\.\S+/.test(v);
+}
+
+/* ---------- Public schedule functions ---------- */
+
+/**
+ * Schedule an email job via QStash.
+ * Returns an object with { ok, id?, error? } so callers can respond accordingly.
+ */
+export async function scheduleEmailJob(
+  email: unknown,
+  subject: unknown,
+  delay?: unknown
+): Promise<PublishResult> {
+  if (!isValidEmail(email)) {
+    return { ok: false, error: "Invalid email provided." };
+  }
+  if (!isNonEmptyString(subject)) {
+    return { ok: false, error: "Invalid subject provided." };
+  }
+  const payload: any = {
+    api: {
+      name: "email",
+      baseUrl: QSTASH_BASE_URL,
+    },
+    body: { email, subject },
+  };
+  if (typeof delay === "string" && delay.trim() !== "") payload.delay = delay;
+  return safePublishJSON(payload);
+}
+
+/**
+ * Schedule an analytics job.
+ */
+export async function scheduleAnalyticsJob(userId: unknown): Promise<PublishResult> {
+  if (!isNonEmptyString(userId)) {
+    return { ok: false, error: "Invalid userId provided." };
+  }
+  const payload = {
+    api: { name: "analytics", baseUrl: QSTASH_BASE_URL },
+    body: { userId },
+  };
+  return safePublishJSON(payload);
+}
+
+/**
+ * Schedule a subscription-check job (default: 1d delay).
+ */
+export async function scheduleSubscriptionCheck(userId: unknown): Promise<PublishResult> {
+  if (!isNonEmptyString(userId)) {
+    return { ok: false, error: "Invalid userId provided." };
+  }
+  const payload = {
+    api: { name: "subscription-check", baseUrl: QSTASH_BASE_URL },
+    body: { userId },
+    delay: "1d",
+  };
+  return safePublishJSON(payload);
+}
diff --git a/package.json b/package.json
new file mode 100644
index 0000000..2842244
--- /dev/null
+++ b/package.json
@@ -0,0 +1,30 @@
+{
+  "name": "ethereal-presence",
+  "version": "0.0.0",
+  "private": true,
+  "scripts": {
+    "dev": "vite",
+    "build": "vite build",
+    "preview": "vite preview",
+    "test": "vitest"
+  },
+  "dependencies": {
+    "react": "19.0.0",
+    "react-dom": "19.0.0"
+  },
+  "overrides": {
+    "react": "19.0.0",
+    "react-dom": "19.0.0"
+  },
+  "devDependencies": {
+    "@netlify/edge-functions": "^3.0.2",
+    "@netlify/functions": "^5.1.0",
+    "@types/node": "^22.10.0",
+    "@types/react": "^19.0.0",
+    "@types/react-dom": "^19.0.0",
+    "@vitejs/plugin-react": "^5.1.1",
+    "typescript": "^5.7.2",
+    "vite": "^7.2.6",
+    "vitest": "^1.0.0"
+  }
+}
diff --git a/tests/qstash.test.ts b/tests/qstash.test.ts
new file mode 100644
index 0000000..d8f9a0b
--- /dev/null
+++ b/tests/qstash.test.ts
@@ -0,0 +1,30 @@
+import { describe, it, expect } from "vitest";
+import * as qstashModule from "../lib/queue/qstash";
+
+describe("qstash wrapper", () => {
+  it("returns error when QSTASH_TOKEN is not configured", async () => {
+    const res = await qstashModule.scheduleEmailJob("invalid-email", "subj");
+    expect(res.ok).toBe(false);
+    expect(res.error).toBeDefined();
+  });
+
+  it("validates inputs for scheduleEmailJob", async () => {
+    const res = await qstashModule.scheduleEmailJob("user@example.com", "");
+    expect(res.ok).toBe(false);
+    expect(res.error).toMatch(/subject/i);
+  });
+
+  it("validates inputs for scheduleAnalyticsJob", async () => {
+    const res = await qstashModule.scheduleAnalyticsJob("");
+    expect(res.ok).toBe(false);
+    expect(res.error).toMatch(/userId/i);
+  });
+});
diff --git a/tsconfig.json b/tsconfig.json
new file mode 100644
index 0000000..707b1b5
--- /dev/null
+++ b/tsconfig.json
@@ -0,0 +1,30 @@
+{
+  "compilerOptions": {
+    "target": "ES2022",
+    "lib": ["ES2022", "DOM", "DOM.Iterable"],
+    "module": "ESNext",
+    "skipLibCheck": true,
+    "types": ["node"],
+    "moduleResolution": "bundler",
+    "allowImportingTsExtensions": true,
+    "resolveJsonModule": true,
+    "isolatedModules": true,
+    "noEmit": true,
+    "jsx": "react-jsx",
+    "strict": true,
+    "noUnusedLocals": true,
+    "noUnusedParameters": true,
+    "noFallthroughCasesInSwitch": true,
+    "baseUrl": ".",
+    "paths": {
+      "@/*": ["./*"]
+    }
+  },
+  "include": [
+    "*.tsx",
+    "*.ts",
+    "netlify/**/*.ts",
+    "netlify/**/*.mts",
+    "lib/**/*.ts",
+    "lib/**/*.mts",
+    "server/**/*.ts",
+    "server/**/*.mts"
+  ],
+  "exclude": ["node_modules", "dist"]
+}
diff --git a/.gitignore b/.gitignore
new file mode 100644
index 0000000..e69de29
--- /dev/null
+++ b/.gitignore
@@ -0,0 +1,16 @@
+# Node
+node_modules/
+dist/
+build/
+.vite/
+
+# Env files (do not commit secrets)
+.env
+.env.local
+.env.*.local
+.env.*.secret
+.env.production
+.env.development
+
+# Editor / OS artifacts
+.DS_Store
+.idea/
+.vscode/
+*.log
-- 
2.39.1
