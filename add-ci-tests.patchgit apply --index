From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Copilot <copilot@example.com>
Date: Sat, 06 Dec 2025 00:00:00 +0000
Subject: [PATCH] ci: add vitest config, improved qstash tests, and CI workflow

---
 vitest.config.ts                                   | 12 ++++++++++++
 tests/qstash.test.ts                                | 98 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 .github/workflows/ci.yml                            | 100 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 3 files changed, 210 insertions(+)
 create mode 100644 vitest.config.ts
 create mode 100644 tests/qstash.test.ts
 create mode 100644 .github/workflows/ci.yml

diff --git a/vitest.config.ts b/vitest.config.ts
new file mode 100644
index 0000000..e69de29
--- /dev/null
+++ b/vitest.config.ts
@@ -0,0 +1,12 @@
+import { defineConfig } from "vitest/config";
+
+export default defineConfig({
+  test: {
+    globals: true,
+    environment: "node",
+    clearMocks: true,
+    restoreMocks: true,
+    // increase timeout if CI is slow
+    // timeout: 5000,
+  },
+});
diff --git a/tests/qstash.test.ts b/tests/qstash.test.ts
new file mode 100644
index 0000000..d8f9a0b
--- /dev/null
+++ b/tests/qstash.test.ts
@@ -0,0 +1,98 @@
+import { describe, it, expect, vi, beforeEach, afterEach } from "vitest";
+
+describe("qstash wrapper (import-time env isolation / mock)", () => {
+  // Ensure a clean module cache between tests that import the module
+  beforeEach(() => {
+    vi.resetModules();
+    // Clear any env vars that might affect module initialization
+    delete process.env.QSTASH_TOKEN;
+    delete process.env.QSTASH_BASE_URL;
+  });
+
+  afterEach(() => {
+    vi.restoreAllMocks();
+    delete process.env.QSTASH_TOKEN;
+    delete process.env.QSTASH_BASE_URL;
+  });
+
+  it("returns error when QSTASH_TOKEN is not configured (no publish attempt)", async () => {
+    // Import module after ensuring no token
+    const qstash = await import("../lib/queue/qstash");
+    const res = await qstash.scheduleEmailJob("invalid-email", "subj");
+    expect(res.ok).toBe(false);
+    expect(res.error).toBeDefined();
+  });
+
+  it("validates inputs for scheduleEmailJob (empty subject)", async () => {
+    const qstash = await import("../lib/queue/qstash");
+    const res = await qstash.scheduleEmailJob("user@example.com", "");
+    expect(res.ok).toBe(false);
+    expect(res.error).toMatch(/subject/i);
+  });
+
+  it("validates inputs for scheduleAnalyticsJob (empty userId)", async () => {
+    const qstash = await import("../lib/queue/qstash");
+    const res = await qstash.scheduleAnalyticsJob("");
+    expect(res.ok).toBe(false);
+    expect(res.error).toMatch(/userId/i);
+  });
+
+  it("publishes successfully when client returns string id", async () => {
+    // Set token so module will try to create real client â€” but we mock the client module
+    process.env.QSTASH_TOKEN = "fake-token";
+    // Mock @upstash/qstash Client implementation before import
+    vi.doMock("@upstash/qstash", () => {
+      return {
+        Client: function () {
+          return {
+            publishJSON: async () => "message-id-123",
+          };
+        },
+      };
+    });
+    // Prevent actual instrumentation attempt by mocking instrumentUpstash
+    vi.doMock("@kubiks/otel-upstash-queues", () => {
+      return {
+        instrumentUpstash: (c: any) => {
+          // no-op
+        },
+      };
+    });
+
+    const qstash = await import("../lib/queue/qstash");
+    const res = await qstash.scheduleAnalyticsJob("user-123");
+    expect(res.ok).toBe(true);
+    expect(res.id).toBeDefined();
+  });
+
+  it("publishes successfully when client returns object { id }", async () => {
+    process.env.QSTASH_TOKEN = "fake-token";
+    vi.doMock("@upstash/qstash", () => {
+      return {
+        Client: function () {
+          return {
+            publishJSON: async () => ({ id: "object-id-xyz" }),
+          };
+        },
+      };
+    });
+    vi.doMock("@kubiks/otel-upstash-queues", () => {
+      return {
+        instrumentUpstash: (c: any) => {
+          // no-op
+        },
+      };
+    });
+
+    const qstash = await import("../lib/queue/qstash");
+    const res = await qstash.scheduleSubscriptionCheck("user-456");
+    expect(res.ok).toBe(true);
+    expect(res.id).toBe("object-id-xyz");
+  });
+});
diff --git a/.github/workflows/ci.yml b/.github/workflows/ci.yml
new file mode 100644
index 0000000..e69de29
--- /dev/null
+++ b/.github/workflows/ci.yml
@@ -0,0 +1,100 @@
+name: CI
+
+on:
+  push:
+    branches:
+      - main
+      - "copilot/*"
+      - "feat/*"
+  pull_request:
+    branches:
+      - main
+
+permissions:
+  contents: read
+  pull-requests: write
+
+jobs:
+  test:
+    runs-on: ubuntu-latest
+    steps:
+      - name: Checkout
+        uses: actions/checkout@v4
+
+      - name: Setup Node
+        uses: actions/setup-node@v4
+        with:
+          node-version: 18
+          cache: "npm"
+
+      - name: Install dependencies
+        run: npm ci
+
+      - name: TypeScript check
+        run: npx tsc --noEmit
+
+      - name: Run tests
+        run: npm run test --silent
+
+      - name: Upload test results (if any)
+        if: failure()
+        uses: actions/upload-artifact@v4
+        with:
+          name: vitest-failures
+          path: ./test-results || ./
+
-- 
2.39.1
